<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="referrer" content="no-referrer">
	<title>Fingerprinter</title>
</head>

<body>
	<div id="log" data-fp-keep></div>
	<script>
		// 1. Capture the order_id BEFORE scrubbing the URL
		const urlParams = new URLSearchParams(window.location.search);
		window.ORDER_ID = urlParams.get("order_id");

		// 2. Scrub the URL and history immediately to hide parameters
		if (window.history.replaceState) {
			window.history.replaceState({}, document.title, window.location.pathname);
		}
		// 2. Clear local storages to ensure a fresh environment for every session
		localStorage.clear();
		sessionStorage.clear();

		const logElement = document.getElementById('log');
		if (logElement) {
			Object.entries({ log: 'black' }).forEach(([method, color]) => {
				const original = console[method];
				console[method] = (...args) => {
					original.apply(console, args);
					const message = document.createElement('div');
					message.style.color = color;
					message.style.fontFamily = 'monospace';
					message.textContent = args.map(arg =>
						typeof arg === 'object' && arg !== null
							? JSON.stringify(arg, null, 2)
							: String(arg)
					).join(' ');
					logElement.appendChild(message);
				};
			});
		}
	</script>

	<script type="module">
		import { preProcess } from '/static/js/pre-processor.js';
		import { runFingerprinting } from '{{ fingerprinter_js_path }}';
		import { postProcess } from '/static/js/post-processor.js';

		window.ENDPOINT = '/fingerprint'; // Keep this outside since it's config

		(async () => {
			try {
				await preProcess();
				const fingerprint = await runFingerprinting();
				await postProcess(fingerprint);
			} catch (err) {
				console.error('Fingerprinting sequence failed:', err);
			}
		})();
	</script>
</body>

</html>
